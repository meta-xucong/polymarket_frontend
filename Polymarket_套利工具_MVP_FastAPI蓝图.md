# Polymarket 套利工具 · 最小可行 Web 版蓝图（FastAPI 版）

> 目标：在不大改现有脚本的前提下，做一个只给你自己用的单用户 Web 控制台：
> - 浏览器里选策略（taker/maker/扫尾）
> - 填参数，一键启动
> - 看当前账户持仓 & 最近日志  
> 不做多用户、不做 Telegram、不做复杂统计 & DB。

---

## 0. 范围 & 不做的事

本轮 MVP 仅做：

1. 一个运行在 VPS 上的 FastAPI 服务
2. 三个策略的 Web 表单页：
   - taker 吃单波段套利
   - maker 挂单波段套利
   - 临近结束扫尾单
3. 一个账户状态页：
   - 调用你现有「查询持仓」脚本，展示当前 Polymarket 仓位
4. 简单的「运行结果查看」：
   - 每次启动策略时，打一个独立日志文件
   - 页面上可以看到「最近一次运行」的若干行输出

本轮明确不做：

- 不做用户注册 / 登录 / 权限（默认只有你自己用）
- 不做多用户资金托管逻辑
- 不做数据库持久化（胜率、历史统计先不做）
- 不做 Telegram Bot / 外部接口
- 不要求域名 / HTTPS（可以先用 IP:PORT 内部访问）

---

## 1. 技术路线（MVP 版）

### 1.1 技术栈

- 后端：FastAPI
- 运行：uvicorn（开发/测试），后续稳定可再加 nginx
- 模板：Jinja2（FastAPI 原生支持）
- 前端：简单 HTML + Bootstrap 表单（或你习惯的简单 CSS）

### 1.2 基本思路

1. 把你现有的 3 套脚本，继续当作独立 Python 程序来看待
2. FastAPI 通过 subprocess 调用脚本：
   - 启动时，传入用户在网页上填的参数
   - 标准输出写入日志文件
3. FastAPI 提供几类页面：
   - 策略启动页：表单 + 启动按钮
   - 账户状态页：展示当前持仓
   - 最近一次运行日志页：从对应日志文件尾部读几行给你看

核心原则：先跑起来再说。不要求策略可在 Web 上被「暂停 / 杀死」，第一版只要能一键启动 + 查看结果就够。

---

## 2. 目录与文件角色（概念级）

建议在现有仓库下增加一个 webapp 子目录，大致结构：

- webapp/
  - main.py：FastAPI 入口
  - routes/
    - ui.py：返回 HTML 页面的路由（index/策略页/账户页/日志页）
    - actions.py：处理表单提交、启动脚本
  - templates/
    - base.html：通用布局（导航栏）
    - index.html：首页（简单说明 + 快捷链接）
    - taker_wave.html：taker 策略表单
    - maker_wave.html：maker 策略表单
    - end_sweeper.html：扫尾单策略表单
    - account.html：账户持仓展示
    - run_log.html：最近运行日志
  - static/
    - CSS/JS（可选）

同时预留一个日志目录，例如：logs/strategy/  
- 每次运行命名一个文件：taker_YYYYMMDD_HHMMSS.log 之类

---

## 3. Phase 0：准备现有脚本（只做最小改动）

目标：让 3 套脚本都能被「参数化调用」，方便 FastAPI 用命令行调用。

### 3.1 统一脚本入口形式

确保你有 3 个稳定入口文件，例如：

- cli/run_taker_wave.py
- cli/run_maker_wave.py
- cli/run_end_sweeper.py

它们具备三个特征：

1. 全部通过命令行参数接收配置（不要再 input()）
2. 运行完一轮策略后自然退出（不需要长时间守护循环）
3. 标准输出中包含足够的信息，可读可调试

你可以先用命令行测试类似调用：

- python cli/run_taker_wave.py --market-url ... --side YES --size 10 --drop-pct 3 --profit-pct 1
- python cli/run_maker_wave.py ...
- python cli/run_end_sweeper.py ...

只要这三条在 Linux 终端都能跑通，FastAPI 就能直接复用。

### 3.2 日志输出规范

- 脚本本身只需正常 print 即可
- FastAPI 在启动脚本时，将 stdout 重定向到日志文件
- 你在日志页只要读这个日志文件即可

---

## 4. Phase 1：FastAPI Web 控制台（单用户）

### 4.1 页面与路由规划

页面视角（给你用）：

1. /（首页）
   - 简短文字说明
   - 三个按钮：taker / maker / 扫尾单
   - 一个按钮：查看账户状态
   - 一个按钮：查看最近一次运行日志

2. /taker_wave  
   - 表单字段示例：
     - 市场 URL / token id
     - 方向（YES/NO）
     - 份数 / 预算
     - 大跌阈值
     - 盈利阈值
   - 提交后跳转到「运行结果提示页」或「首页 + 提示」

3. /maker_wave  
   - 类似，只是字段略有差别（如挂单价偏移参数等）

4. /end_sweeper  
   - 填：市场 URL / 结束时间 buffer / 最大价格等

5. /account  
   - 当前持仓表格（从现有查询脚本获取）

6. /last-log  
   - 展示最近一次运行的日志（例如最后 200 行）

API 视角（内部使用）：

- POST /run/taker_wave：接收表单数据，调用 taker 脚本
- POST /run/maker_wave：调用 maker 脚本
- POST /run/end_sweeper：调用扫尾脚本
- GET /account/data：返回当前持仓数据（页面内部用或直接由 ui 路由调用）

第一版完全可以只用 HTML 表单 + 页面跳转，不需要前后端分离。

### 4.2 策略启动流程（subprocess 版）

1. 用户在 /taker_wave 填好表单，点击「启动」
2. FastAPI：
   - 校验参数（非常基础，例如不能为空/数值合法）
   - 构造一条命令行调用现有脚本
   - 为本次运行生成一个日志文件名
   - 用子进程启动脚本，将输出写入日志文件（后台运行即可）
   - 把「已启动」「日志文件路径」的信息暂存在内存（或简单文本文件）

3. 返回给用户：
   - 一个状态提示（例如页面显示「已启动，稍后可以在『最近日志』查看」）

4. 用户查看 /last-log：
   - 从最新的日志文件中读取最后一段内容
   - 以 <pre> 的形式显示

注意：MVP 不做「停止策略」按钮，也不做多策略并发管理。默认使用完一次策略后脚本自行退出。

---

## 5. Phase 1.5：账户状态页（复用现有脚本）

### 5.1 复用逻辑

你已有类似 view_positions.py 之类功能，现在只需：

1. 确定一个「统一的查询脚本」：
   - 能输出当前账户的所有持仓（token_id、市场标题、方向、数量、均价、标记价、未实现盈亏等）
   - 最好支持一种机器易解析的格式（例如 JSON），如果还没有，可以后面再加

2. FastAPI 侧操作：

   - 调用该脚本：
     - 简单版：通过 subprocess 直接调用脚本并读取输出文本
     - 若输出是 JSON，则直接解析成 Python 对象
   - 将解析结果传入模板，在 /account 页面显示为表格：
     - 列：#、市场名、方向、数量、均价、现价、浮盈/浮亏

这一块逻辑是「纯展示」，不会动数据库，也不会下单，只要能正常读到当前仓位就够。

---

## 6. Phase 2 以后（非本轮任务，只做标记）

本蓝图的「最小可行子集」做到以上 0–5，即视为完成。  
你未来若要商业化/多用户/Telegram Bot，可以在此基础上继续扩展：

- 加用户模型 & 登录
- 接数据库记录每次交易，做胜率统计
- 接入域名 & HTTPS
- 增加 Telegram Bot 调用后台 API

这些都可以视为后续版本的增量需求。

---

## 7. 小结：MVP 版落地顺序

按实际操作顺序再压缩一遍：

1. 整理脚本入口  
   - 确保 3 个策略有统一的 CLI 调用方式（无 input()，全参数化）
   - 本地命令行测试 OK

2. 搭一个最小 FastAPI 项目  
   - 一个首页 + 一个简单策略表单（先从 taker 开始）
   - 提交表单后，subprocess 调用脚本，写日志文件

3. 增加日志查看页 /last-log  
   - 读取最新日志文件，页面展示

4. 接入账户状态页 /account  
   - 调用你现有的持仓查询脚本，解析输出并展示表格

5. 复制策略页  
   - 在 taker 跑通的基础上，按同一模式加 maker & 扫尾单表单

做到这一步，你就已经拥有：

- 浏览器里点几下就能启动任一策略
- 看当前账户持仓
- 在网页上看最近一次策略的执行日志

这就是本轮「最小可行子集（FastAPI 版）」的完整目标。
